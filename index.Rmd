---
title: "Predicting Drivers of Common Buckthorn"
author: Sean Colby
subtitle: Generation of a Buckthorn SDM
---

# Introduction

Common Buckthorn

Background: 
Common Buckthorn is a deciduous tree/shrub species which was introduced in the late 1800's as an ornamental from Eurasia (Knight et al. 2007). While it may have served a role as an ornamental, it has done a large amount of ecological harm to the Northeastern United States and South East Canada. For example, Common Buckthorn has been known to more than double nitrogen and organic matter content in soils compared to native vegetation resulting in decreased habitat diversity (Klionsky et al. 2011). Furthermore, since Buckthorn is highly competitive having a higher growth rate and fecundity than most native shrubs, it is then able to become quickly become a monoculture and out shade native species. To make matters worse, Buckthorn is allelopathic and reduces native species richness and native biomass production (Warren et al. 2017). 


Problem:
Due to Common Buckthorn being extremely damaging to native ecosystems it is imperative to model its spread in order to attempt to control it. While many researchers have done large multiple state prediction models of Common Buckthorn, to my knowledge very few have done a small scale single state SDM.


Questions: 
1. Will this small scale of an SDM be relatively accurate? 
2. What can we make of the plot as to what forests/areas appear to be more likely to be invaded than others?
3. Since we are focusing on habitat suitability, is buckthorn's presence more likely due to habitat suitability or dispersal methods?


# Materials and methods

Study Area: 
This study area is made up of 160 sites that were randomly selected from the following New York counties; Monroe, Livingston, Wyoming, and Ontario. Using these sites, environmental variables of soil, climatic, vegetation, and topographic data were collected.

```{r}
#Load Library
library(spData)
library(tidyverse)
library(sf)

#Load Sites
sites<-read.csv("160_Sites.csv")%>%
st_as_sf(coords= c("longitude","Ã¯..latitude"),crs=4326)
data(us_states)
NY= us_states[us_states$NAME == "New York",]
NY_SF<-st_as_sf(NY)

ggplot(NY_SF, col = "grey95")+
  geom_sf()+
  geom_sf(data= sites, pch=4)
```

Methods:

Generating Logistic Regression to Find Predictors for SDM

Data for Logistic Regression: 
(FIll in Later)

Logisitic Regression Codes:
```{r}
#Load in Libraries
library(tidyverse)
library(stats)

#Read in Data
Buckthorn_All_Sites <- read.csv("All_Sites.csv")

#Calculate Logistic Regression Using What Variables are believed to be best
Buckthorn_All <- glm(formula= Buckthorn~temp0509+GR0.50+Compaction+Clay+terrain.slope+pH,data=Buckthorn_All_Sites, family="binomial")

#Note that you must type in each variable and play with testing variables that both make the most sense as well as yield the best p-value. 

```

Using the same stats package to fit linear models and predict what controls Common Buckthorn's relative abundance
-*Note* this is an additional test to not only create a habitat suitability model of buckthorn, but to also see what environmental variable increases abundance beyond just presence absence. 

```{r, message=F, warning=F}
#Load in the Libraries
library(tidyverse)
library(stats)

#Read in Data that contains only "invaded" sites
Buckthorn_only <- read.csv("Buckthorn_only.csv")

#Create Linear Model using what variables are believed to be best
Buckthorn <- lm(formula = X.Buckthorn~temp0509+nonveg.100+Canopy.Cover, data= Buckthorn_only)
knitr::opts_chunk$set(cache=TRUE)  
```

## Download Data from Open Source and Generate Predictive Model
```{r}
#Load Libraries
library(sp)
library(sf)
library(spData)
library(raster)
library(maptools)
library(rgdal)
library(dismo)
library(tidyverse)
library(FedData)

#Set Boundaries of Base Map
data(us_states)
NY= us_states[us_states$NAME == "New York",]

#Download Environmental Data
bioclim.data <- getData(name = "worldclim",
                        var = "bio",
                        res = 2.5,)

#Crop the Climatic data only to the extent of the occurences
bioclim.data <- crop(x = bioclim.data, y = NY)%>%mask(mask=NY)

#Read in Occurrence Data
Occurence <- read.csv("Buckthorn_Occurence.csv")%>%
st_as_sf(coords= c("longitude","latitude"),crs=4326)

#Add long+lat back into Occurence
Occurence[,c("longitude","latitude")]= st_coordinates(Occurence)

#Begin to build distribution model
bc.model <- bioclim(x = bioclim.data, p = st_coordinates(Occurence))

# Drop unused column
obs.data <- Occurence[, c("latitude", "longitude")]

# Reverse order of columns
obs.data <- obs.data[, c("longitude", "latitude")]

# Build species distribution model
bc.model <- bioclim(x = bioclim.data, p = st_coordinates(obs.data))

#Predict estimated presence
predict.presence <- dismo::predict(object = bc.model, 
                                   x = bioclim.data, 
                                   ext = NY)

#Make Predict Presence a data frame for ggplot 2
prediction<-as.data.frame(predict.presence, xy=TRUE)

# Generate random points/pseudo absence points
bil.files <- list.files(path = "wc2-5/", 
                        pattern = "*.bil$", 
                        full.names = TRUE)

mask <- raster(bil.files[1])

set.seed(20210707)

#Insert Random Points over specified area
background <- randomPoints(mask = mask,
                           n= nrow(obs.data),
                           ext = NY,
                           extf = 1.25)

#Save random points as data frame

Pseudo<- as.data.frame(background)

#This sets equal groups for testing

testing.group <- 1

group.presence <- kfold(x = obs.data, k = 5)


#Set Training and Testing Groups

presence.train <- obs.data[group.presence != testing.group, ]

presence.test <- obs.data[group.presence == testing.group, ]

#Training and testing for pseudo points

group.background <- kfold(x = background, k = 5)

background.train <- background[group.background != testing.group, ]

background.test <- background[group.background == testing.group, ]


#Build model using training
bc.model <- bioclim(x = bioclim.data, p = st_coordinates(presence.train))
predict.presence <- dismo::predict(object = bc.model, 
                                   x = bioclim.data, 
                                   ext = NY)

predict.presence_df<- as.data.frame(predict.presence)
#Testing and Evaluation
bc.eval <- evaluate(p = presence.test,   # The presence testing data
                    a = background.test, # The absence testing data
                    model = bc.model,    # The model we are evaluating
                    x = bioclim.data)    # Climatic variables for use by model

# Determine minimum threshold for "presence"
bc.threshold <- threshold(x = bc.eval, stat = "spec_sens")

Presence_Absence= predict.presence > bc.threshold
```



# Results


##Logistic Regression Results
```{r}
summary(Buckthorn_All)
```

##Linear Regression Results
```{r}
summary(Buckthorn)
```

##Initial SDM Setup
```{r}
ggplot(NY,col = "grey95")+
  geom_sf()+
  geom_sf(data=Occurence, size=1, color="black")+
  geom_raster(data=prediction, aes(x = x, y = y, fill= layer), alpha=.65)+
  scale_fill_gradientn(colours = terrain.colors(7))+
  ggtitle("Buckthorn SDM of NY")+
  xlab("longitude")+
  ylab("latitude")+
  theme(plot.title = element_text(hjust = 0.5))
```

##Trained and Evaluated Model with Set Threshold
```{r}
ggplot(NY,col = "grey95")+
  geom_sf()+
  geom_sf(data=Occurence, size=1, color="black")+
  geom_raster(data= as.data.frame(Presence_Absence, xy=T), aes(x = x, y = y, fill= layer))+
  #scale_fill_gradientn(colours = terrain.colors(7))+
  ggtitle("Buckthorn SDM of NY")+
  xlab("longitude")+
  ylab("latitude")+
  theme(plot.title = element_text(hjust = 0.5))
```
##Model Stats Summary
```{r}
view(bc.eval)
```

# Conclusions

[~200 words]

Clear summary adequately describing the results and putting them in context. Discussion of further questions and ways to continue investigation.

# References

All sources are cited in a consistent manner
